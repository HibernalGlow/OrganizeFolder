# 安全合并指南

## ⚠️ 重要安全更新

原来的 `mergef` 工具存在严重的安全隐患，可能导致文件永久丢失。现在已经更新为安全版本。

## 安全问题说明

### 原来的问题
1. **直接删除文件夹**：使用 `folder.rmdir()` 直接删除，如果移动失败文件夹就永久丢失
2. **不安全的文件移动**：使用 `shutil.move()` 可能导致文件在移动过程中丢失
3. **没有备份机制**：操作失败时无法恢复原始数据
4. **异常处理不当**：出现错误时可能导致数据处于不一致状态

### 新的安全机制
1. **自动备份**：操作前自动创建带时间戳的备份文件夹
2. **安全文件移动**：先复制后删除，确保数据安全
3. **完整性验证**：验证文件大小确保复制成功
4. **原子操作**：只有在所有文件都成功移动后才删除原文件夹
5. **恢复功能**：提供备份恢复命令

## 使用方法

### 1. 安全合并（推荐）
```bash
# 基本用法
mergef merge

# 从剪贴板读取路径
mergef merge --clipboard

# 预览模式（不实际执行）
mergef merge --preview

# 指定路径
mergef merge "C:\path\to\folder"
```

### 2. 列出备份
```bash
# 列出当前目录的备份
mergef list-backups

# 列出指定目录的备份
mergef list-backups "C:\path\to\search"
```

### 3. 恢复数据
```bash
# 从备份恢复
mergef restore "C:\path\to\backup\mergef_backup_20240726_143022" "C:\path\to\restore\target"
```

### 4. 不安全模式（不推荐）
```bash
# 仅用于兼容性，强烈不推荐使用
mergef merge-unsafe
```

## 安全特性详解

### 自动备份
- 每次合并操作前自动创建备份
- 备份文件夹命名格式：`mergef_backup_YYYYMMDD_HHMMSS`
- 包含所有将要修改的文件夹的完整副本

### 安全文件操作
```python
def safe_move_file(src, dst):
    # 1. 先复制文件
    shutil.copy2(src, dst)
    
    # 2. 验证复制是否成功
    if dst.exists() and dst.stat().st_size == src.stat().st_size:
        # 3. 复制成功后才删除原文件
        src.unlink()
        return True
    else:
        # 4. 复制失败则清理并返回错误
        if dst.exists():
            dst.unlink()
        return False
```

### 原子操作保证
- 只有在所有文件都成功移动后才删除原文件夹
- 如果任何文件移动失败，保留原文件夹不变
- 使用临时重命名确保文件夹重命名的原子性

## 错误恢复

### 如果合并过程中出现错误
1. 检查控制台输出的错误信息
2. 查找备份文件夹位置（会在输出中显示）
3. 使用 `mergef restore` 命令恢复数据

### 如果需要手动恢复
1. 找到备份文件夹（通常在操作目录下）
2. 手动复制备份文件夹中的内容到原位置
3. 删除不完整的合并结果

## 最佳实践

### 操作前
1. **总是先使用预览模式**：`mergef merge --preview`
2. **确保有足够的磁盘空间**：备份需要额外空间
3. **关闭正在使用这些文件的程序**

### 操作中
1. **不要中断操作**：让程序完整执行完毕
2. **注意观察输出信息**：特别是错误和警告
3. **记录备份文件夹位置**

### 操作后
1. **验证合并结果**：检查文件是否正确合并
2. **保留备份一段时间**：确认无问题后再删除
3. **如有问题立即恢复**：使用 restore 命令

## 故障排除

### 常见问题

#### 1. 权限不足
```
错误：Permission denied
解决：以管理员身份运行命令行
```

#### 2. 磁盘空间不足
```
错误：No space left on device
解决：清理磁盘空间或选择其他位置进行操作
```

#### 3. 文件被占用
```
错误：The process cannot access the file because it is being used by another process
解决：关闭正在使用文件的程序
```

#### 4. 路径包含特殊字符
```
错误：Invalid path
解决：使用引号包围路径，或避免特殊字符
```

### 紧急恢复步骤
1. 停止当前操作（Ctrl+C）
2. 找到最新的备份文件夹
3. 使用 `mergef restore` 或手动复制恢复数据
4. 检查数据完整性
5. 重新规划合并策略

## 版本历史

### v2.0.0（安全版本）
- ✅ 添加自动备份功能
- ✅ 实现安全文件移动
- ✅ 添加完整性验证
- ✅ 提供恢复命令
- ✅ 改进错误处理

### v1.x.x（不安全版本）
- ❌ 直接删除文件夹
- ❌ 不安全的文件移动
- ❌ 无备份机制
- ❌ 可能导致数据丢失

## 技术支持

如果遇到问题：
1. 查看本指南的故障排除部分
2. 检查备份文件夹是否存在
3. 保留错误日志信息
4. 描述具体的操作步骤和错误现象

记住：**数据安全第一，操作谨慎为上！**
